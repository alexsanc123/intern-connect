<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intern Connect</title>
  <script type="importmap">
    {
      "imports": {
        "vue": "https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.esm-browser.js",
        "@graffiti-garden/implementation-local": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-local@0.6.4/dist/browser/index.js",
        "@graffiti-garden/implementation-remote": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-remote@0.6.2/dist/browser/index.js",
        "@graffiti-garden/wrapper-vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-vue@0.7.2/dist/browser/plugin.mjs"
      }
    }
  </script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div id="app">
      <!-- Login area when not logged in -->
      <div v-if="!$graffitiSession.value" class="login-container">
        <h1>Intern Connect</h1>
        <p>Connect with other interns, join teams, and chat with people who share your interests!</p>
        <button @click="$graffiti.login()">Log In</button>
      </div>
      
      <!-- Main app when logged in -->
      <template v-else>
        <button @click="$graffiti.logout($graffitiSession.value)" class="logout-button">
          Log Out
        </button>

        <graffiti-discover
          :channels="[ $graffitiSession.value.actor ]"
          :schema="{}"
          v-slot="{ objects, isInitialPolling }"
        >
          <profile-loader
            v-if="!isInitialPolling && objects.length"
            :data="objects[objects.length - 1].value"
            @loaded="initProfile"
          />
        </graffiti-discover>
  
        <!-- Homepage -->
        <div v-if="!isInitialPolling && bottomNavActive === 'home'">
          <div v-if="currentTeam">
            <header>
              <button class="back-button" @click="backToTeams">
                ← Back
              </button>
              <h1>{{ currentTeam.name }}</h1>
              <nav class="tab-bar">
                <button
                  :class="{ active: teamActiveTab === 'Members' }"
                  @click="teamActiveTab = 'Members'">
                  Members
                </button>
                <button
                  :class="{ active: teamActiveTab === 'Chat' }"
                  @click="teamActiveTab = 'Chat'">
                  Chat
                </button>
                <button
                  :class="{ active: teamActiveTab === 'Events' }"
                  @click="teamActiveTab = 'Events'">
                  Events
                </button>
              </nav>
            </header>
          
            <main class="container">
              <!-- MEMBERS LIST -->
              <section v-if="teamActiveTab === 'Members'">
                <graffiti-discover
                  v-slot="{ objects: memberObjs, isInitialPolling }"
                  :channels="[ currentTeam.name ]"
                  :schema="{
                    properties:{
                      value:{
                        required:['userId','displayName'],
                        properties:{
                          userId:      { type:'string' },
                          displayName: { type:'string' }
                        }
                      }
                    }
                  }"
                >
                  <div v-if="!isInitialPolling" class="membership-controls">
                    <button
                      v-if="!memberObjs.some(m => m.value.userId === $graffitiSession.value.actor)"
                      @click="joinTeam()"
                    >
                      Join Team
                    </button>
                    <button
                      v-else
                      @click="leaveTeam()"
                    >
                      Leave Team
                    </button>
                  </div>
              
                  <!-- MEMBER LIST -->
                  <ul class="member-list">
                    <li v-if="isInitialPolling" class="loading">Loading members…</li>
                    <li v-else-if="!memberObjs.length" class="empty-message">
                      No members have joined yet.
                    </li>
                    <li v-else v-for="m in memberObjs" :key="m.url" class="member-row">
                      <graffiti-discover
                        :channels="[ m.value.userId ]"
                        :schema="{ properties:{ value:{ required:['name'], properties:{ name:{ type:'string' } } } } }"
                        v-slot="{ objects: userProfiles, isInitialPolling: loadingProf }"
                      >
                        <span class="member-name">
                          {{ loadingProf
                             ? m.value.displayName
                             : (userProfiles.length
                                 ? userProfiles[userProfiles.length-1].value.name
                                 : m.value.displayName)
                          }}
                        </span>
              
                        <!-- only show Chat if not me -->
                        <button
                          v-if="m.value.userId !== $graffitiSession.value.actor"
                          @click="openChatWithMember({
                            id: m.value.userId,
                            displayName: userProfiles.length
                              ? userProfiles[userProfiles.length-1].value.name
                              : m.value.displayName
                          })"
                        >
                          Chat
                        </button>
                      </graffiti-discover>
                    </li>
                  </ul>
                </graffiti-discover>
              </section>
              
              <!-- TEAM GROUP CHAT -->
              <section v-else-if="teamActiveTab === 'Chat'">
                <div class="chat-window">
                  <div class="chat-body">
                    <graffiti-discover
                      v-slot="{ objects: messageObjects, isInitialPolling }"
                      :channels="[ currentTeam.name ]"
                      :schema="{ properties:{ value:{ required:['content','published'], properties:{ content:{type:'string'}, published:{type:'number'} } } } }"
                    >
                      <ul class="chat-messages">
                        <li v-if="isInitialPolling" class="loading-message">Loading messages…</li>
                        <li
                        v-for="msg in messageObjects.sort((a,b) => b.value.published - a.value.published)"
                        :key="msg.url"
                        :class="msg.actor === $graffitiSession.value.actor ? 'my-message' : 'other-message'"
                        >
                        <div class="message-content">
                            <div class="message-header">
                            <strong>{{ msg.actor }}</strong>
                            <span v-if="msg.actor === $graffitiSession.value.actor" class="you-tag">(you)</span>
                            </div>
                            <div class="message-body">{{ msg.value.content }}</div>
                        </div>
                        <div class="message-actions" v-if="msg.actor === $graffitiSession.value.actor">
                            <button @click="edit(msg)">Edit</button>
                            <button @click="deleteMessage(msg, $graffitiSession.value)">Delete</button>
                        </div>
                        </li>

                      </ul>
                    </graffiti-discover>
                  </div>
          
                  <div class="chat-input-area">
                    <form @submit.prevent="handleMessage($graffitiSession.value)">
                      <fieldset :disabled="sending">
                        <input ref="messageInput" type="text" v-model="myMessage" placeholder="Type a message…" v-focus />
                        <button type="submit">{{ editingMessage ? 'Update' : (sending ? 'Sending…' : 'Send') }}</button>
                      </fieldset>
                    </form>
                  </div>
                </div>
              </section>
          
              <!-- EVENTS (placeholder) -->
              <section v-else-if="teamActiveTab === 'Events'">
                <p class="empty-message">
                  Events for {{ currentTeam.name }} will go here.
                </p>
              </section>
            </main>
          </div>

          <!-- Main homescreen -->
          <div v-else>
            <header>
              <h1>Intern Connect</h1>
              <nav class="tab-bar">
                <button :class="{ active: activeTab === 'Teams' }" @click="activeTab = 'Teams'">Teams</button>
                <button :class="{ active: activeTab === 'Interests' }" @click="activeTab = 'Interests'">Interests</button>
                <button :class="{ active: activeTab === 'Events' }" @click="activeTab = 'Events'">Events</button>
              </nav>
            </header>
    
            <main class="container">
              <!-- Teams Tab -->
                <section v-if="activeTab === 'Teams'">
                  <h2>My Teams</h2>
                  <input type="text" v-model="searchTeams" placeholder="Search teams…" />
                  <ul>
                    <li
                      v-for="team in teams
                        .filter(t => profileData.teams.includes(t.name))
                        .filter(t => t.name.toLowerCase().includes(searchTeams.toLowerCase()))"
                      :key="team.name"
                      @click="openTeam(team, 'Members')"
                      class="team-row"
                    >
                    <button class="team-link">{{ team.name }}</button>
                      <div class="action-buttons">
                        <button @click="openTeam(team, 'Chat')">
                          Chat
                        </button>
                        <button class="leave-button" @click="leaveTeam(team)">
                          Leave
                        </button>
                      </div>
                    </li>
                    <li v-if="!profileData.teams.length" class="empty-message">
                      You haven't joined any teams yet.
                    </li>
                  </ul>
  
                  <h3>Other Teams</h3>
                  <ul>
                    <li
                      v-for="team in teams
                        .filter(t => !profileData.teams.includes(t.name) &&
                                    t.name.toLowerCase().includes(searchTeams.toLowerCase()))"
                      :key="team.name"
                      @click="openTeam(team, 'Members')"
                    >
                      <span>{{ team.name }}</span>
                      <div class="action-buttons">
                        <button @click="openTeam(team, 'Chat')">
                          Chat
                        </button>
                        <join-button
                          :joined="profileData.teams.includes(team.name)"
                          @join="joinTeam(team)"
                        />
                      </div>
                    </li>
                  </ul>
                </section>
  
  
                <section v-else-if="activeTab === 'Interests'">
                  <h2>My Interests</h2>
                  <input type="text" v-model="searchInterests" placeholder="Search interests…" />
                  <ul>
                    <li v-for="interest in interests.filter(i => profileData.interests.includes(i.name)).filter(i => i.name.toLowerCase().includes(searchInterests.toLowerCase()))" :key="interest.name">
                      <span>{{ interest.name }}</span>
                      <div class="action-buttons">
                        <button @click="selectChat({ name: interest.name, channel: interest.name })">Chat</button>
                        <button class="leave-button" @click="leaveInterest(interest)">Leave</button>
                      </div>
                    </li>
                    <li v-if="!profileData.interests.length" class="empty-message">You haven't joined any interests yet.</li>
                  </ul>
      
                  <h3>Other Interests</h3>
                  <ul>
                    <li v-for="interest in interests.filter(i => !profileData.interests.includes(i.name) && i.name.toLowerCase().includes(searchInterests.toLowerCase()))" :key="interest.name">
                      <span>{{ interest.name }}</span>
                      <div class="action-buttons">
                        <button @click="selectChat({ name: interest.name, channel: interest.name }, false)">Chat</button>
                        <join-button :joined="profileData.interests.includes(interest.name)"  @join="joinInterest(interest)"/>
                      </div>
                    </li>
                  </ul>
                </section>
      
                <!-- Events Tab -->
                <section v-else-if="activeTab === 'Events'">
                  <h2>Events</h2>
                  <p class="empty-message">Events content will go here.</p>
                </section>
            </main>
          </div>
        </div>
        <div v-else-if="isInitialPolling && bottomNavActive === 'home'" class="loading-message">
          Loading your profile…
        </div>

        
  
        <!-- Chat View -->
        <div v-if="bottomNavActive === 'chats'">
            <header>
              <h1>Intern Connect</h1>
            </header>
          
            <main class="container">
              <div v-if="!currentChat">
                <div class="create-group-form">
                  <h2>Create Group Chat</h2>
                  <form @submit.prevent="createGroupChat($graffitiSession.value)">
                    <input type="text" v-model="groupChatName" placeholder="New group chat name" v-focus />
                    <button type="submit" :disabled="creatingGroup || !groupChatName">
                      {{ creatingGroup ? 'Creating…' : 'Create Chat' }}
                    </button>
                  </form>
                </div>
          
                <section>
                  <h2>My Chats</h2>
                  <ul>
                    <li v-for="chat in profileData.chats" :key="chat.channel">
                        <span>{{ chat.name }}</span>
                        <div class="action-buttons">
                          <button @click="selectChat(chat)">Open</button>
                          <button class="leave-button" @click="leaveChat(chat.channel)">Leave</button>
                        </div>
                      </li>
                    <li v-if="!profileData.chats.length" class="empty-message">
                      You haven't joined any chats yet.
                    </li>
                  </ul>
                </section>
          
                <section>
                  <h2>All Chats</h2>
                  <graffiti-discover
                    v-slot="{ objects: listingObjs, isInitialPolling }"
                    :channels="channels"
                    :schema="{}"
                  >
                    <ul>
                      <li v-if="isInitialPolling" class="loading-message">Loading chats…</li>
                      <li v-for="chat in mergedChats(listingObjs)" :key="chat.channel">
                        <span>{{ chat.name }}</span>
                        <button
                          v-if="!profileData.chats.some(c => c.channel === chat.channel)"
                          @click="selectChat(chat)"
                        >Join</button>
                        <span v-else class="joined-tag">Joined</span>
                      </li>
                    </ul>
                  </graffiti-discover>
                </section>
              </div>
          
              <div v-else>
                <div class="chat-window">
                  <div class="chat-header">
                    <button type="button" @click="currentChat = null">&larr; Back</button>
                    <h2>Chat: {{ selectedChatName }}</h2>
                    <div class="chat-header-actions">
                      <join-button :joined="chatMembers[currentChat]?.includes(profileData.name)" @join="addSelfToChat"></join-button>
                      <button v-if="chatMembers[currentChat]?.includes(profileData.name)" class="leave-button" @click="leaveChat(currentChat)">Leave Group</button>
                      <button @click="rename" v-if="!renameMode">Rename</button>
                    </div>
                  </div>
          
                  <form v-if="renameMode" @submit.prevent="submitRename($graffitiSession.value)" class="rename-form">
                    <input type="text" v-model="renameGroupName" v-focus required />
                    <button type="submit">Save</button>
                    <button type="button" @click="renameMode = false">Cancel</button>
                  </form>
          
                  <div class="chat-body">
                    <graffiti-discover
                      v-slot="{ objects: messageObjects, isInitialPolling }"
                      :channels="messageChannels"
                      :schema="{ properties:{ value:{ required:['content','published'], properties:{ content:{type:'string'}, published:{type:'number'} } } } }"
                    >
                      <ul class="chat-messages">
                        <li v-if="isInitialPolling" class="loading-message">Loading messages…</li>
                        <li
                        v-for="msg in messageObjects.sort((a,b) => b.value.published - a.value.published)"
                        :key="msg.url"
                        :class="msg.actor === $graffitiSession.value.actor ? 'my-message' : 'other-message'"
                        >
                        <div class="message-content">
                            <div class="message-header">
                            <strong>{{ msg.actor }}</strong>
                            <span v-if="msg.actor === $graffitiSession.value.actor" class="you-tag">(you)</span>
                            </div>
                            <div class="message-body">{{ msg.value.content }}</div>
                        </div>
                        <div class="message-actions" v-if="msg.actor === $graffitiSession.value.actor">
                            <button @click="edit(msg)">Edit</button>
                            <button @click="deleteMessage(msg, $graffitiSession.value)">Delete</button>
                        </div>
                        </li>

                      </ul>
                    </graffiti-discover>
                  </div>
          
                  <div class="chat-input-area">
                    <form @submit.prevent="handleMessage($graffitiSession.value)">
                      <fieldset :disabled="sending || renameMode">
                        <input ref="messageInput" type="text" v-model="myMessage" placeholder="Type a message…" v-focus />
                        <button type="submit">{{ editingMessage ? 'Update' : (sending ? 'Sending…' : 'Send') }}</button>
                      </fieldset>
                    </form>
                  </div>
                </div>
          
                <div class="chat-members">
                    <h3>Members ({{ chatMembers[currentChat]?.length || 0 }})</h3>
                    <div class="member-search">
                      <form @submit.prevent="addMember">
                        <input v-model="newMember" placeholder="Add user by name…" required />
                        <button type="submit" class="add-button">Add</button>
                      </form>
                    </div>
                    <ul class="member-list">
                      <li v-for="member in chatMembers[currentChat] || []" :key="member">
                        <span class="member-name">{{ member }}</span>
                        <span v-if="member === profileData.name" class="you-tag">(you)</span>
                        <button 
                          v-if="member !== profileData.name" 
                          type="button" 
                          @click="removeMember(member)" 
                          class="remove-button"
                          title="Remove from chat">×</button>
                      </li>
                      <li v-if="(chatMembers[currentChat] || []).length === 0" class="empty-message">
                        No one has been added yet.
                      </li>
                    </ul>
                  </div>
              </div>
            </main>
        </div>
  
        <!-- Profile View -->
        <div v-if="bottomNavActive === 'profile'">
          <header>
            <h1>Intern Connect</h1>
          </header>
          <main class="container">
            <section class="profile-section">
              <h2>Your profile</h2>
              <graffiti-discover
                :channels="[ $graffitiSession.value.actor ]"
                :schema="{
                  properties:{
                    value:{
                      required:['name','age','chats'],
                      properties:{
                        name:    {type:'string'},
                        age:     {type:'number'},
                        chats:   {type:'array', items:{type:'string'}},
                        interests:{ type:'array', items:{type:'string'} },
                        teams:   {type:'array', items:{type:'string'}}
                      }
                    }
                  }
                }"
                v-slot="{ objects, isInitialPolling }"
              >
                <profile-loader
                  v-if="!isInitialPolling && objects.length"
                  :data="objects[objects.length - 1].value"
                  @loaded="initProfile"
                />
              </graffiti-discover>
              <profile-form v-model="profileData" @save="saveProfile"/>
              <profile-card v-if="profileData.name || profileData.age" :profile="profileData"/>
            </section>
          </main>
        </div>
  
        <!-- Bottom Navigation -->
        <footer class="bottom-nav">
          <button :class="{ active: bottomNavActive === 'home' }" @click="bottomNavActive = 'home'">Home</button>
          <button :class="{ active: bottomNavActive === 'chats' }" @click="bottomNavActive = 'chats'">Chats</button>
          <button :class="{ active: bottomNavActive === 'profile' }" @click="bottomNavActive = 'profile'">Profile</button>
        </footer>
      </template>
    </div>
    <script src="index.js" type="module"></script>
  </body>
  
</html>
